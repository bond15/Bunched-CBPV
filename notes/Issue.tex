\documentclass{article}
    % General document formatting
    \usepackage[margin=0.7in]{geometry}
    \usepackage[parfill]{parskip}
    \usepackage[utf8]{inputenc}
    \usepackage{xcolor}
    \usepackage{hyperref}
    
    % Related to math
    \usepackage{stmaryrd}
    \usepackage{amsmath,amssymb,amsfonts,amsthm}
    \newcommand{\den}[1]{\llbracket #1 \rrbracket}
    \newcommand{\sep}{\mathrel{-\mkern-6mu*}}
    \newcommand{\blue}[1]{\textcolor{blue}{#1}}
    \newcommand{\red}[1]{\textcolor{red}{#1}}
    \newcommand{\pshC}{\widehat{\mathcal{C}}}
    \newcommand{\pshCC}{\widehat{\mathcal{C \times C}}}
    \newcommand{\dayprod}{\otimes^{Day}}


\begin{document}
\section{Bicartesian Doubly Closed Category}
Given a category $\mathcal{C}$, its presheaf category ($\pshC := [\mathcal{C}^{op}, Set]$)
is bicartesian closed. Given a monoidal category ($\mathcal{C}, \otimes_C , I_C$), 
its presheaf category is bicartesian closed and monoidal closed via the Day convolution. 
The monoidal product is given by:
\[
    (P \dayprod Q)(x) = \int_{}^{y,z} \mathcal{C}[ x , y \otimes_C z ] 
    \times P(y) \times Q(z)
\]

The Day monoidal product has the universal property that any maps out of it are in bijective
correspondence with a family of maps natural in $x$ and $y$ 
\href{https://github.com/bond15/Bunched-CBPV/blob/82136dc6f4f9e4034391877f0d959a6ff1b62dfc/src/Data/BiDCC.agda#L222}
{(Agda)}: 
\footnote{here $\overline{\times}$ is the \textit{external} product}


\[
    \pshC[P \dayprod Q , R] \;\cong \; \pshCC [ P \overline{\times} Q , R \circ \otimes_C ]\; \cong \; \Pi_{x, y : \;ob \;C}\; Set[P(x) \times Q(y) , R(x \otimes_C y)]
\]

The monoidal closed structure is given by: 
\begin{align*}
    (P \sep Q)(X) = \pshC[P , Q(X , -)]
\end{align*}
With the universal property that the closed structure is right adjoint to the tensor
\href{https://github.com/bond15/Bunched-CBPV/blob/82136dc6f4f9e4034391877f0d959a6ff1b62dfc/src/Data/BiDCC.agda#L354}{(Agda)}: 
\begin{align}
    \pshC [ A \otimes_C B , C] \cong \pshC [ A , B \sep C]
\end{align}

Bicartesian doubly closed categories have been used in the denotational semantics of bunched type theories 
\cite{pym_semantics_2002}\cite{bieringLogicBunchedImplications}\cite{ohearn_bunched_2003}.

\section{Towards Bunched Call By Push Value with Dynamic Store}
Categorical models of dynamic store use presheaf categories to model the dependence of the heap structure on a current \textit{world}
\cite{CBPVbook}\cite{sterling_denotational_2023}\cite{kammarMonadFullGround2017}. Seemingly none of these existing models 
attempt to combine a call by push value language with the separating type connectives, $\otimes$ and $\sep$, used in bunched type theories.
Our investigation into possible models of such a language have run into some potential issues. To illustrate this, we will start with the 
model for a call by push value language with dynamic store presented in chapter 7 of Levy's thesis.

\subsection{Definitions}
Let ($C, \otimes_C , I_C$) be a monoidal category, the value category be $\mathcal{V} := [C , Set]$, computation category $\mathcal{C} := [C^{op}, Set]$, and use the \textit{standard}
monad for ground dynamic store with $F : \mathcal{V} \rightarrow \mathcal{C}$ as:
\[
    F(A)(x) := \Sigma_{y : ob \;C}\Sigma_{f : C[ x , y ]}A(y)    
\]
and $U : \mathcal{C} \rightarrow \mathcal{V}$ as :
\[
    U(\underline{B})(x) := \Pi_{y : ob \; C}\Pi_{f : C [ x , y]}\underline{B}(y)   
\]

The oblique morphisms in this model are given by families of maps:
\[
    \mathcal{O}[A , \underline{B}] := \Pi_{x : ob \; C} Set[A(x) , \underline{B}(x)]   
\]

we have the following isomorphims:
\[
    \mathcal{V}[A , U(\underline{B})] \cong \mathcal{O}[A , \underline{B}] \cong \mathcal{C}[F(A) , \underline{B}]   
\]
And we can attempt to define a computation separating function by:
\[
    (A \sep \underline{B})(x) := \Pi_{y : ob \;C} Set[A(y), \underline{B}(x \otimes_C y)]
\]
\subsection{Problems with an Abstract Monoidal Category}
Before committing to the category 
of worlds used in Levy's model, we will work with an arbitrary monoidal category ($C, \otimes_C , I_C$). 
\subsubsection{Issue 1: Universal Property of Tensor for Oblique Morphisms}
Let's attempt to show the following:
\[
  \mathcal{O}[P \otimes Q , \underline{R}] \cong \mathcal{O\times}[P \overline{\times} Q , \underline{R} \circ \otimes_C]  
\]
where 
\[
    \mathcal{O\times}[P \overline{\times} Q , \underline{R} \circ \otimes_C] 
    := \Pi_{x , y : ob \;C}Set[P(x)\times Q(y) , \underline{R}(x \otimes_C y)]
\]

A problem arises when trying to define the backwards map of this isomorphims. 
Given $m : \mathcal{O\times}[P \overline{\times} Q , \underline{R} \circ \otimes_C]$ and $x : ob \; C$, we need to define a map
$Set[(P \otimes Q)(x), \underline{R}(x)]$. This is a map out of a coequalizer 
\footnote{since coends in $Set$ can be encoded as coequalizers}
which we can attempt to give as a map induced from:
\[
    (f : y\otimes_C z \rightarrow x , p : P(y) , q : Q(z)) \mapsto \;? : \underline{R}(x)
\]
However, using the data we currently have, we can only construct
\[
    m(y)(z)(p,q) : \underline{R} (y \otimes_C z)    
\]
and since $\underline{R}$ is contravariant, we can't use $\underline{R}(f) : \underline{R}(x) \rightarrow \underline{R}(y \otimes_C z)$.
This is not surprising since the proof of this universal property in the value category 
$\mathcal{V}[P \otimes Q , R] \cong \mathcal{V\times}[P \overline{\times} Q , R \circ \otimes_C]$
uses the functorial action of $R$ on $f$ 
(see \href{https://github.com/bond15/Bunched-CBPV/blob/d4de5ebe3a2a42499b24c13a8d2da7f3a2cc1b36/src/Data/BiDCC.agda#L120}{here})
\footnote{note the difference in variance is due to the fact this proof is for presheaves and not covariant presheaves}
So by swapping the variance of $R$ (now $\underline{R}$ since it is from the computation category) this proof should break.
Seemingly, this proof won't go through when we assume a generic monoidal category $C$. Perhaps we can recover this property if 
we work with a specific concrete category?

\subsubsection{Issue 2: Universal Property of the Separating Function Type}
This is just another perspective on the variance issue above. We'd like to show
\[
    \mathcal{O}[P \otimes Q , \underline{R}] \cong \mathcal{O}[P , Q \sep \underline{R}]    
\]
Since we don't have the universal property of tensor for oblique morphisms, we can try to get at this proof via the 
universal property of tensor in the value category. Note that we have
\[
    \mathcal{O}[P \otimes Q , \underline{R}] \cong \mathcal{V}[P \otimes Q , U(\underline{R})] \cong \mathcal{V\times}[P \overline{\times} Q , U(\underline{R}) \circ \otimes_C] 
\]
and 
\[
    \mathcal{O}[P , Q \sep \underline{R}] \cong \mathcal{V}[P , U(Q \sep \underline{R})]
\]
So we can try to show 
\[
    \mathcal{V\times}[P \overline{\times} Q , U(\underline{R}) \circ \otimes_C] \cong \mathcal{V}[P , U(Q \sep \underline{R})]
\]
Again, we fail to define the backwards direction of this isomorphim due to a variance issue with $\underline{R}$. 
Given $m : \mathcal{V}[P , U(Q \sep \underline{R})]$, it suffices to construct a map 
$eval : \mathcal{V\times}[ U(Q \sep \underline{R}) \overline{\times} Q , U(\underline{R}) \circ \otimes_C] $ with components 
\[
    (x , y)(f : U(Q \sep \underline{R})(x), q : Q(y)) \mapsto \;? \;: \;  (U(\underline{R}))(x \otimes_C y)    
\]
unfolding some of the definitions, we have 
\begin{align*}
    f &: \Pi_{z : ob \;C}\Pi_{g : C[x , z]}(\Pi_{w : ob \; C}Set[Q(w), \underline{R}(z \otimes_c w)])\\
    ? &: \Pi_{z : ob \;C}\Pi_{g : C[x \otimes_C y, z]}(R(z))
\end{align*}
Thus we have to define $? : \underline{R}(z)$ from the following data:
\begin{align*}
    &x,y,z : ob \;C \\
    &q : Q(y)\\
    &f : \Pi_{z : ob \;C}\Pi_{g : C[x , z]}(\Pi_{w : ob \; C}Set[Q(w), \underline{R}(z \otimes_c w)])\\
    &g : C[x\otimes_C y , z]
\end{align*}
The \textit{obvious} thing do to would be to use $f (x)(id_x)(y)(q) : \underline{R}(x \otimes_C y)$ and $\underline{R}(g)$, 
but the variance of $\underline{R}$ is working against us.

\section{Issue}
There is a variance issue when trying to add a \textbf{computational} separating 
function type to Levy's dynamic store model\cite{CBPVbook}
\footnote{Chapter 6}\footnote{The following issue exists in our setup too.}. Take the category 
of worlds to be $\mathcal{W} := FinSet_{mono}$, the value category to be $\mathcal{V} :=  [\mathcal{W}, Set]$ 
and the computation category to be $\mathcal{C} := [\mathcal{W}^{op} , Set]$. 
Value judgments $\Gamma \vdash_v M : A$ are denoted as morphisms in $\mathcal{V}$.
Computation judgments $\Gamma \vdash_c M : B$ are denoted as families of maps $\forall(w : ob \;W) 
\rightarrow Set[ \den{\Gamma}(w) , \den{B}(w)]$. Note that we are dropping the storage
part (S) of Levy's monad. The monoidal structure on $\mathcal{W}$ given by disjoint union yields a monoidal
structure on $\mathcal{V}$ via the Day convolution\footnote{\textit{covariant}
Day convolution given by taking the monoidal structure on $\mathcal{W}^{op}$ and
then applying the day convolution}. 

\[
    (A \otimes_D B)_0(w_1) = \int_{}^{w_2,w_3} \mathcal{W}[ w_2 \otimes w_3 , w_1 ] 
    \times A(w_2) \times B(w_3)
\]

The separating function in the \textbf{value category}($A , B : ob \;\mathcal{V}$) is given by:
\[
    (A \sep B)_0(w) = \mathcal{V}[ \den{A} , \den{B}(w \otimes \_)]
\]
And we have that:
\begin{align}
    \mathcal{V} [ A \otimes_D B , C] \cong \mathcal{V} [ A , B \sep C]
\end{align}
The \textbf{computational} function type ($A : ob \;\mathcal{V} , B : ob \;\mathcal{C}$) is given by:
\[ 
    (A \rightarrow B)_0(w) = Set[ \den{A}(w) , \den{B}(w)]
\]
We can try to define the \textbf{computational} separating function ($A : ob \;\mathcal{V} , B : ob \;\mathcal{C}$) as :
\[
    (A \sep B)_0(w) = \forall(w' : ob \; W) \rightarrow Set[ \den{A}(w'), \den{B}(w \otimes w')] 
\]
which is a contravariant functor. We should expect the following isomorpism of types(in Set?):
\[
    (A \otimes_D B) \rightarrow C \cong A \rightarrow B \sep C  
\]
given by:
\begin{align*}
    &fun : ((A \otimes_D B) \rightarrow C) \rightarrow (A \rightarrow B \sep C )\\
    &fun \; M \; w_1 \;(a : \den{A}(w_1)) \; w_2 \;(b : \den{B}(w_2)) = M (w_1 \otimes w_2)(id_{w_1 \otimes w_2} , a , b)\\
    \\
    &inv :(A \rightarrow B \sep C ) \rightarrow ((A \otimes_D B) \rightarrow C)\\
    &inv \; M \; w_1 \; (w_2,w_3,f : w_2 \otimes w_3 \rightarrow w_1, a : \den{A}(w_2), b : \den{B}(w_3)) = \red{\den{B}_1(f)}(M \; w_2 \; a \; w_3 \; b)
\end{align*}
However, the variance of $\den{B}$ gives us $\den{B}_1(f) : \den{B}(w_1) \rightarrow \den{B}(w_2 \otimes w_3)$ 
which is the opposite direction that \textit{we want}\footnote{Meaning this is how the isomorpism goes in (1)}.
\subsection{Our Model}
I was able to derive an \textit{inverse} (likely not able to show the isomorphism) in our model, 
but it felt like a hack and involves an \red{arbitrary choice}. Without reproducing all the details here, 
the gist is the following:

\begin{align*}
    &s2p : \mathcal{V}[ A \otimes_D B , A \times B]    \\
    &s2p (w_1)(w_2,w_3,f : w_2 \otimes w_3 \hookrightarrow w_1, a , b) = \den{A}_1(inl\; ; f )(a) , \den{B}_1(inr \; ; f)(b)\\
    \\
    &inv :(A \rightarrow B \sep C ) \rightarrow ((A \otimes_D B) \rightarrow C)\\
    &inv \; M \; w \; s = \den{B}_1(\red{inl \; or \; inr})(M \; w \; (\pi_1 \; p)\; w \; (\pi_2 \;p)) \\ 
    & \;\;\;\; where \\
    & \;\;\;\;\;\;\;\; p : \den{A \times B}(w)\\
    & \;\;\;\;\;\;\;\; p = s2p \; w \; s
\end{align*}

\section{A possible way forward}
I'm starting to look at a weaker version of the setup in section 2.4 of \cite{sterling_denotational_2023} 
which is a model of $\textrm{SystemF}_{\mu}^{ref}$. I think we had already worked out the 
computational separating function for an algebra model of CBPV. 

\bibliographystyle{acm}
\bibliography{ref}
\end{document}